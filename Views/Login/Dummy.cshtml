@{
    ViewData["Title"] = "Dummy";

    Layout = "~/Views/Shared/_LayoutLogin.cshtml";

}

@* @HttpContext.Session.GetString("user_name"); *@
<div class="app-content content">
    <div class="content-wrapper">
        <div class="content-header row">
        </div>
        <div class="content-body">
            <section class="flexbox-container" id="divPage" data-ng-controller="ctrlApp">
                @* <li class="nav-item">
                    <a class="nav-link text-dark" asp-area="MicrosoftIdentity" asp-controller="Account" asp-action="SignOut">Sign out</a>
                    </li> *@
                <div class="col-12 d-flex align-items-center justify-content-center">
                    <div class="col-md-4 col-10 box-shadow-2 p-0">
                        <div class="card border-grey border-lighten-3 px-1 py-1 m-0">
                            <div class=" card-header border-0">
                                <div class="card-title text-center">
                                    <img src="~/assets/images/logo-thaioil.png" alt="branding logo" class="pr-1" />
                                    <br />
                                    <b style="font-family: Montserrat">EOSL DASHBOARD</b>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="card-body">
                                    <form ng-submit="handleSubmit($event)">
                                        <div class="form-group position-relative has-icon-left">
                                            <input class="form-control" data-ng-model="form.user_name" name="user_name" placeholder="Your Username" required />
                                            <div class="form-control-position">
                                                <i class="ft-user"></i>
                                            </div>
                                        </div>
                                        <div class="form-group position-relative has-icon-left">
                                            <input class="form-control" type="password" data-ng-model="form.pass_word" name="Password" placeholder="Password" required />
                                            <div class="form-control-position">
                                                <i class="fa fa-key"></i>
                                            </div>

                                        </div>
                                        <div class="form-group position-relative has-icon-left text-center">
                                            <input type="submit" Class="btn btn-primary w-100" value="Login" />
                                            @* <button data-ng-click="handleSubmit($event)" class="btn btn-primary w-100">Login</button> *@
                                        </div>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <div class="loader" id="divLoading" data-html2canvas-ignore="false">
            <h3>
                <i class="fa fa-circle-o-notch fa-spin fa-fw"></i>&#32;Loading&#8230;
            </h3>
        </div>
    </div>
</div>
@section scripts {
@* <script src="~/js/angular.min.js" , asp-append-version="true"></script> *@

<script>
    const app = angular.module("app", []);
    app.controller("ctrlApp", function ($scope, $http) {
        console.log(`@ViewBag.endpoint`)
        $scope.email = `@ViewBag.email`;
        $scope.perfex = `@ViewBag.perfex`;
        $scope.autoLogin = `@ViewBag.autoLogin`;
        const loginAzure = `@ViewBag.loginAzure`;
        $scope.loginAzure = loginAzure === 'true' ? true : false;
        $scope.form = {
            user_name: "",
            pass_word: "",
        }
        $scope.handleSubmit = function (ev) {
            const {user_name,
                pass_word} = $scope.form
            if (!user_name || !pass_word) {return;}
            $scope.login()
        }

        $scope.login = () => {

            $('#divLoading').show();
            $http.post('@Url.Content("~/")Login/Authentication', $scope.form).then(({data}) => {

                if (data) {
                    console.log(data);
                    console.log(data.user_name);
                    checkHistory(data.user_name, data.page);
                    new Promise(res => {
                        setTimeout(() => {res($('#divLoading').hide())}, 2000)
                    }).then(() => {
                        window.open(`@Url.Content("~/")${data.page}`, "_top")
                    })
                }
            }).catch((err) => {
                $('#divLoading').hide();
                console.log(err)
                var errmsg = "";
                if (err.data.includes(`No authority login in system(1).`)) {
                    errmsg = `No authority login in system(1).`;
                    alert(errmsg);
                    return;
                }
                if (err.data.includes(`Login wrong username and password.`)) {
                    errmsg = `Login wrong username and password.`;
                    alert(errmsg);
                    return;
                }
                console.log(err)
            }).finally(() => {

            })
        }




    });


    function CheckBrowser() {
        try {
            var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) {return p.toString() === "[object SafariRemoteNotification]";})(!window['safari'] || (typeof safari !== 'undefined' && safari.pushNotification));
            // Internet Explorer 6-11
            @* var isIE = /cc_on!/false || !!document.documentMode; *@
                        // Edge 20+
                        var isEdge = !isIE && !!window.StyleMedia;
            // Chrome 1 - 71
            var isChrome = !!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime);
            // Blink engine detection
            var isBlink = (isChrome) && !!window.CSS;

            if (isSafari == true) {return "isSafari";}
            if (isIE == true) {return "isIE";}
            if (isEdge == true) {return "isEdge";}
            if (isChrome == true) {return "isChrome";}
            if (isBlink == true) {return "isBlink";}
        }
        catch (ex) { }
    }

    if (CheckBrowser() == "isIE") {
        try {
            var shell = new ActiveXObject("WScript.Shell");
            shell.run("Chrome http://eosldashboard.thaioilgroup.com/web/login.aspx");
            window.open('', '_parent', ''); window.close();
        } catch (ex) {
            window.open("index_settings.html", "_top");
        }
    }
    function checkHistory(usernamex, page_name) {

        var url = "@ViewBag.apiLog";

        var data = {};
        data.USERNAME = usernamex;
        data.APP_NAME = "EOSL Dashboard";
        data.URL = window.location.pathname;
        data.MODULE = "EOSL Dashboard";
        const host = window.location.host;
        $.ajax({
            type: "POST",
            url: url,
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {

            },
            error: function () {
            }
        });

    }


    angular.element(document).ready(function () {
        angular.bootstrap($('#divPage'), ['app']);
    });
</script>
<script type="module">
    import http from './assets/js/request.js'
    window.addEventListener("load", async () => {

        return;
        let baseURL = '<%= ConfigurationManager.AppSettings["wsADLogin"].ToString() %>';
        let search = new URLSearchParams(window.location.search);
        let access_token = search.get("access_token");
        if (access_token) {
            let param = {access_token: access_token}
            try {
                let body = await http.request(baseURL + "/validateAccesstoken", param);
                let data = body
                var user_id = data.user_id;

                let user_password = document.querySelector("#user_password");
                user_password.value = "admin1";
                let user_name = document.querySelector("#user_name");
                user_name.value = user_id;

                let btnlogin = document.querySelector("#btnlogin");
                if (user_password.value && user_name.value) {
                    btnlogin.click();
                }
            }
            catch (error) { }
        }
        else {
            let param = {url: window.location.href}
            let body = await http.request(baseURL + "/getRedirectToken", param);
            let data = body
            window.open(data.RedirectUrl, "_self")
        }
    })
</script>
}
